%==================================================%
% Basic setup starts here
%==================================================%
\documentclass[12pt, letterpaper]{amsart} % this will automatically load amsmath and amsthm packages
\usepackage{amsfonts}
\usepackage{amscd} % a CD environment for commutative rectangular diagram
\usepackage{mathtools} % for \shortintertext
\usepackage[utf8]{inputenc} % encoding method
\usepackage[mathscr]{eucal} % eucal calligraphy, mathsrc = use \mathcal
\usepackage{indentfirst} % indent first line of all sections
\usepackage{graphicx} % extension of graphics, options for \includegrahpicx
\usepackage{pict2e} % new implementation of the picture environment, which allows programming pictures directly LaTeX
\usepackage{epic} % add some command to the picture environment
\usepackage[margin=2.9cm]{geometry} % customize page layout
\usepackage{glossaries}
%==================================================%
% Additional setup ends here
%==================================================%
% Additional package used for relevant article
\usepackage{physics} % partial derivative \pdv
\usepackage{cleveref} % automatically add eq in referencing
\usepackage{cancel}
\usepackage{tikz}
% SELF-DEFINED THEOREM using amsthm package
\newtheorem{Th}{Theorem}[section]
\numberwithin{equation}{section}
\newtheorem{Def}[Th]{Definition}
%==================================================%
% Glossary
%==================================================%
%==================================================%
% Document starts here
% ==================================================%
\author{Kin Chang}
\title{2 wheeled robot Derivation}
\begin{document}
\maketitle
\section{Symbols}
\begin{tabular}{cp{0.6\textwidth}}
  $L_x$ & length of the box  \\
  $L_y$ & width of the box \\
  $D_w$ & diameter of the wheel \\
  $D_b$ & distance between the two wheels \\
  $l_x$ & range sensor measurement along x \\
  $l_y$ & range sensor measurement along y \\
  $\alpha$ & MPU angle measurement \\
  $r_x$ & absolute x coordinate of the car \\
  $r_y$ & absolute x coordinate of the car \\
  $\theta$ & absolute orientation of the car \\
  $\phi_L$ & Servo input: angle rotation of the left wheel \\
  $\phi_R$ & Servo input: angle rotation of the right wheel \\
  $\theta_{tht}$ & Top half threshold angle \\
  $\theta_{thb}$ & Bottom half threshold angle \\
  $\theta_{thr}$ & Bottom right threshold angle \\
  $\theta_{thl}$ & Bottom left threshold angle \\  
\end{tabular}\\
\section{Assumption}
For the sake of simplicity, we have the following assumption in the derivation below
\begin{enumerate}
\item $\theta$ takes value only (-90, 90)
\item $\phi_L$ and $phi_R$ has the same magnitude, opposite sign if turning, otherwise same sign 
\item $\theta = \alpha$ assuming we have the the MPU calibrated at the 0 point
\end{enumerate}  
\section{Introduction}
\begin{align*}
  \intertext{State}
  x = 
  \begin{bmatrix}
    r_x \\
    r_y \\
    \theta 
  \end{bmatrix} \\
  \intertext{Sensor Measurements}
  y = 
  \begin{bmatrix}
    l_x \\
    l_y \\
    \alpha
  \end{bmatrix} \\
  \intertext{Input}
  u = 
  \begin{bmatrix}
    \phi_L \\
    \phi_R
  \end{bmatrix} \\  
\end{align*}

\section{Sensor Measurement}
We want to find a function such that $y = h(x)$ \\
We define the following threshold angles:
\begin{align*}
  \theta_{tht} &= \arctan(\frac{L_y - r_y}{L_x - r_x}) \\
  \theta_{thb} &= \arctan(\frac{r_y}{r_x}) \\
  \theta_{thr} &= \arctan(\frac{L_x-r_x}{r_y}) \\
  \theta_{thl} &= \arctan(\frac{r_x}{r_y})
\end{align*}
Under our assumption, our expression for $l_x$  changes under these four cases:
\begin{align*}
  l_x = \frac{L_x - r_x}{\cos \theta} \quad \theta > 0, |\theta| < \theta_{ttt} \\
  l_x = \frac{L_y - r_y}{\cos (90 - \theta)} \quad \theta > 0, |\theta| > \theta_{ttt} \\
  l_x = \frac{L_y - r_y}{\cos \theta} \quad \theta < 0, |\theta| < \theta_{ttb} \\
  l_x = \frac{r_y}{\cos (90 - \theta)} \quad \theta < 0, |\theta| > \theta_{ttb}
\end{align*}
Our expression for $l_y$ changes under these four cases:
\begin{align*}
  l_y = \frac{r_y}{\cos \theta} \quad \theta > 0, |\theta| < \theta_{ttr} \\
  l_y = \frac{L_x - r_x}{\cos (90 - \theta)} \quad \theta > 0, |\theta| > \theta_{ttr} \\
  l_y = \frac{r_y}{\cos \theta} \quad \theta < 0, |\theta| < \theta_{ttl} \\
  l_y = \frac{r_x}{\cos (90 -\theta)} \quad \theta < 0, |\theta| > \theta_{ttl}
\end{align*}
Our expression for $\alpha = \theta$ doesn't change under our assumption. \par
To summarize, we have total of 8 cases summarized below,
\begin{align*}
  \intertext{$\theta>0, |\theta| < \theta_{ttt}, |\theta| < \theta_{ttr}$}
  y = 
  \begin{bmatrix}
    \frac{L_x - r_x}{\cos \theta} \\
    \frac{r_y}{\cos \theta} \\
    \alpha = \theta
  \end{bmatrix}
  \intertext{$\theta>0, |\theta| < \theta_{ttt}, |\theta| > \theta_{ttr}$}
  y = 
  \begin{bmatrix}
    \frac{L_x - r_x}{\cos \theta} \\
    \frac{L_x - r_x}{\cos (90 - \theta)} \\
    \alpha = \theta
  \end{bmatrix}
  \intertext{$\theta>0, |\theta| > \theta_{ttt}, |\theta| < \theta_{ttr}$}
  y = 
  \begin{bmatrix}
    \frac{L_y - r_y}{\cos (90 - \theta)} \\    
    \frac{r_y}{\cos \theta} \\
    \alpha = \theta
  \end{bmatrix}
  \intertext{$\theta>0, |\theta| > \theta_{ttt}, |\theta| > \theta_{ttr}$}
  y = 
  \begin{bmatrix}
    \frac{L_y - r_y}{\cos (90 - \theta)} \\
    \frac{L_x - r_x}{\cos (90 - \theta)} \\
    \alpha = \theta
  \end{bmatrix}
  %% \theta < 0
  \intertext{$\theta<0, |\theta| < \theta_{ttb}, |\theta| < \theta_{ttl}$}
  y = 
  \begin{bmatrix}
    \frac{L_y - r_y}{\cos \theta} \\
    \frac{r_y}{\cos \theta} \\
    \alpha = \theta
  \end{bmatrix}
  \intertext{$\theta<0, |\theta| < \theta_{ttb}, |\theta| > \theta_{ttl}$}
  y = 
  \begin{bmatrix}
    \frac{L_x - r_x}{\cos \theta} \\
    \frac{r_x}{\cos (90 -\theta)} \\
    \alpha = \theta
  \end{bmatrix}
  \intertext{$\theta<0, |\theta| > \theta_{ttb}, |\theta| < \theta_{ttl}$}
  y = 
  \begin{bmatrix}
    \frac{r_y}{\cos (90 - \theta)} \\    
    \frac{r_y}{\cos \theta} \\
    \alpha = \theta
  \end{bmatrix}
  \intertext{$\theta<0, |\theta| > \theta_{ttb}, |\theta| > \theta_{ttl}$}
  y = 
  \begin{bmatrix}
    \frac{r_y}{\cos (90 - \theta)} \\        
    \frac{r_x}{\cos (90 - \theta)} \\
    \alpha = \theta
  \end{bmatrix}  
\end{align*}
\\
\\
We need to linearize all these cases such that, $y = H u$, where H is a matrix. Here we will demonstrate how to do linearization for one case, $\theta >0, |\theta| < \theta_{ttt}, |\theta| < \theta_{ttr}$,
\begin{align*}
  l_x &= \frac{L_x - r_x}{\cos \theta} \\
  l_y &= \frac{r_y}{\cos \theta} \\
  \intertext{Linearization around $l_{x0}, l_{y0}, \alpha_{0} = h(r_{x0}, r_{y0}, \theta_0)$}
  l_x &= l_{x0} + \frac{-1}{\cos \theta_0} (r_x - r_{x0}) + \frac{(L_x - r_{x0})\sin(\theta_0)}{(\cos{\theta_0})^2} (\theta - \theta_0) \\
  l_y &= l_{y0} + \frac{1}{\cos \theta}(r_y - r_{y0}) + \frac{r_y \sin(\theta_0)}{(\cos \theta_0)^2} (\theta - \theta_0) \\
  l_x &= \frac{-1}{\cos \theta_0} r_x + \frac{(L_x - r_{x0})\sin(\theta_0)}{(\cos{\theta_0})^2} \theta + [\frac{r_{x0}}{\cos \theta_0} - \frac{(L_x - r_{x0})\sin(\theta_0)}{(\cos{\theta_0})^2}\theta_0 + l_{x0}] \\
  l_y &= \frac{1}{\cos \theta_0}r_y + \frac{r_y \sin(\theta_0)}{(\cos \theta_0)^2} \theta + [\frac{-r_{y0}}{\cos \theta_0} - \frac{r_y \sin(\theta_0)}{(\cos \theta_0)^2} \theta_0 + l_{y0}]
\end{align*}
In matrix form, the complete form for this case is
\begin{align*}
  y =
  \begin{bmatrix}
    \frac{-1}{\cos \theta_0} & 0 & \frac{(L_x - r_{x0})\sin(\theta_0)}{(\cos{\theta_0})^2} \\
    0 & \frac{1}{\cos \theta_0} & \frac{r_y \sin(\theta_0)}{(\cos \theta_0)^2} \\
    0 & 0 & 1
  \end{bmatrix}
            \begin{bmatrix}
              r_x \\
              r_y \\
              \theta
            \end{bmatrix}
            +
            \begin{bmatrix}
              \frac{r_{x0}}{\cos \theta_0} - \frac{(L_x - r_{x0})\sin(\theta_0)}{(\cos{\theta_0})^2}\theta_0 + l_{x0} \\
              \frac{-r_{y0}}{\cos \theta_0} - \frac{r_y \sin(\theta_0)}{(\cos \theta_0)^2} \theta_0 + l_{y0} \\
              0
            \end{bmatrix}
\end{align*}
\end{document}
%==================================================%
% Bibliography starts here
%==================================================%
% \bibliographystyle{unsrt}
% \bibliography{my_latex_math_template}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
